<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheFlex</title>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/header.css">
    <link rel="stylesheet" href="./css/UI/button.css">
    <link rel="stylesheet" href="./css/UI/input.css">
    <link rel="stylesheet" href="./css/card.css">

    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/pages/design.css">
    <link rel="stylesheet" href="./css/pages/text.css">
    <link rel="stylesheet" href="./css/pages/name.css">
    <link rel="stylesheet" href="./css/pages/loading.css">
    <link rel="stylesheet" href="./css/pages/result.css">
</head>

<body>
    <div class="wrapper">
        <header class="header">
            <a href="./index.html" class="logo-link">
                <div class="logo-wrap">
                    <img src="./imgs/Logo.svg" alt="" class="logo">
                </div>
            </a>
        </header>
        <main class="main">
            <div class="main-page" style="display: none;">
                <div class="main__container my-container">
                    <div class="main-page__text text">
                        <h1 class="main__title">Hey, flexgirl</h1>
                        <p class="main__pre-title">Ты можешь создать классное <span>персональное приглашение</span> на
                            пробную
                            тренировку <br> для своей <span>подруги</span></p>
                    </div>
                    <button class="main__button my-button">
                        <div class="my-button__icon-wrap">
                            <img src="./imgs/button/lightning.svg" alt="" class="my-button__icon">
                        </div>
                        <span class="my-button__text">нажми, если готова начать</span>
                    </button>
                    <div class="main__reposts reposts">
                        <div class="reposts__counter">
                            <div class="reposts__imgs">
                                <div class="reposts__img-wrap">
                                    <img src="./imgs/reports.png" alt="" class="reposts__img">
                                </div>
                                <div class="reposts__img-wrap">
                                    <img src="./imgs/reports.png" alt="" class="reposts__img">
                                </div>
                                <div class="reposts__img-wrap">
                                    <img src="./imgs/reports.png" alt="" class="reposts__img">
                                </div>
                                <div class="reposts__img-wrap">
                                    <img src="./imgs/reports.png" alt="" class="reposts__img">
                                </div>
                            </div>
                            <div class="reposts__count-text">+<span class="reposts__count">356</span></div>
                        </div>
                        <div class="reposts__text">flex girl отправили приглашение своим подругам</div>
                    </div>
                </div>
                <div class="main__background-images">
                    <img src="./imgs/gray-bag.png" alt="" class="main__gray-back-img">
                    <img src="./imgs/card-img.png" alt="" class="main__card-img">
                </div>
                <img src="./imgs/pink-bottle.png" alt="" class="main__pink-bottle-img">
            </div>
            <div class="main__design design-page" style="display: none;">
                <div class="design-page__container my-container">
                    <div class="design-page__content content">
                        <div class="design-page__text text">
                            <h2 class="design-page__title inner-title">Выбери оформление</h2>
                        </div>
                        <div class="design-page__constructor constructor">
                            <input class="my-input design-page__my-input" type="text" name="design">
                            <div class="design-page__slider design-slider">
                                <div class="swiper design-slider__swiper">
                                    <div class="swiper-wrapper design-slider__swiper-wrapper">
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__design-card design-card" data-design="1">
                                                <div class="design-card__body">
                                                    <img src="./imgs/cards/card1.png" alt="" class="design-card__img">
                                                    <div class="design-card__title"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__design-card design-card" data-design="2">
                                                <div class="design-card__body">
                                                    <img src="./imgs/cards/card2.png" alt="" class="design-card__img">
                                                    <div class="design-card__title"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__design-card design-card" data-design="3">
                                                <div class="design-card__body">
                                                    <img src="./imgs/cards/card3.png" alt="" class="design-card__img">
                                                    <div class="design-card__title"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__design-card design-card" data-design="4">
                                                <div class="design-card__body">
                                                    <img src="./imgs/cards/card4.png" alt="" class="design-card__img">
                                                    <div class="design-card__title"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__design-card design-card" data-design="5">
                                                <div class="design-card__body">
                                                    <img src="./imgs/cards/card5.png" alt="" class="design-card__img">
                                                    <div class="design-card__title"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__design-card design-card" data-design="6">
                                                <div class="design-card__body">
                                                    <img src="./imgs/cards/card6.png" alt="" class="design-card__img">
                                                    <div class="design-card__title"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__design-card design-card" data-design="7">
                                                <div class="design-card__body">
                                                    <img src="./imgs/cards/card7.png" alt="" class="design-card__img">
                                                    <div class="design-card__title"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="swiper-pagination design-slider__swiper-pagination"></div>
                                </div>
                            </div>
                        </div>
                        <button class="design-page__button my-button">
                            <div class="my-button__icon-wrap">
                                <img src="../imgs/button/arrow.svg" alt="" class="my-button__icon">
                            </div>
                            <span class="my-button__text">следующий шаг</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="main__text text-page" style="display: none;">
                <div class="text-page__container my-container">
                    <div class="text-page__content content">
                        <div class="text-page__text text">
                            <h2 class="text-page__title inner-title">Выбери текст</h2>
                        </div>
                        <div class="text-page__constructor constructor">
                            <input class="my-input text-page__my-input" type="text" name="cardText">
                            <div class="text-page__slider text-slider">
                                <div class="swiper text-slider__swiper">
                                    <div class="swiper-wrapper text-slider__swiper-wrapper">
                                        <div class="swiper-slide text-slider__slide swiper-slide-active">
                                            <div class="text-slider__card text-card">
                                                <div class="text-card__inner">
                                                    <div class="text-card__text">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-page__design-card-container">
                                <div class="text-page__design-card design-card">
                                    <div class="design-card__body">
                                        <img src="./imgs/cards/card7.png" alt="" class="design-card__img">
                                        <div class="design-card__title"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="my-button text-page__button">
                            <div class="my-button__icon-wrap">
                                <img src="../imgs/button/arrow.svg" alt="" class="my-button__icon">
                            </div>
                            <span class="my-button__text">следующий шаг</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="main__name name-page" style="display: none;">
                <div class="name-page__container my-container">
                    <div class="name-page__content content">
                        <div class="name-page__text text">
                            <h2 class="name-page__title inner-title">Введи имя подруги</h2>
                        </div>
                        <div class="name-page__constructor constructor">
                            <input class="my-input name-page__my-input" type="text" name="name"
                                placeholder="Введите имя">
                        </div>
                        <button class="name-page__button my-button">
                            <div class="my-button__icon-wrap">
                                <img src="../imgs/button/arrow.svg" alt="" class="my-button__icon">
                            </div>
                            <span class="my-button__text">следующий шаг</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="main__loading loading-page" style="display: none;">
                <div class="loading-page__container my-container">
                    <div class="loading-page__loader loader-wrap">
                        <div class="loader-wrap__text">Происходит магия</div>
                        <div class="loader-wrap__loader"></div>
                    </div>
                    <div class="loading-page__img-wrap">
                        <img src="../imgs/loading-img.png" alt="" class="loading-page__img">
                    </div>
                </div>
            </div>
            <div class="main__result result-page" style="display: none;">
                <div class="result-page__container my-container">
                    <div class="result-page__content content">
                        <div class="result-page__constructor constructor">
                            <div class="result-page__design-card-wrap">
                                <div class="result-page__design-card design-card">
                                    <img src="" alt="" class="result-page__design-card-img">
                                </div>
                            </div>
                        </div>
                        <a href="" class="result-page__link my-button" download>
                            <div class="my-button__icon-wrap">
                                <img src="../imgs/button/arrow.svg" alt="" class="my-button__icon">
                            </div>
                            <span class="my-button__text">Скачать</span>
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <script>
        localStorage.clear();
        document.addEventListener('DOMContentLoaded', () => {
            const mainPage = document.querySelector('.main-page');
            const designPage = document.querySelector('.design-page');
            const textPage = document.querySelector('.text-page');
            const namePage = document.querySelector('.name-page');
            const loadingPage = document.querySelector('.loading-page');
            const resultPage = document.querySelector('.result-page');

            let activeDesign = '';
            let activeDesignImg = '';
            let selectedText = '';
            let resultText = '';
            let imgUrl = '';

            const setPageDisplay = (page, display) => {
                page.style.display = display;
                if (display === 'block') {
                    const constructor = page.querySelector('.constructor');
                    if (constructor) {
                        constructor.classList.add('active');
                    }
                } else {
                    const constructor = page.querySelector('.constructor');
                    if (constructor) {
                        constructor.classList.remove('active');
                    }
                }
            };

            const setBackground = (currentPage) => {
                const backgrounds = {
                    'main-page': '#F5F5F5',
                    'loading-page': '#F5F5F6',
                    'result-page': 'linear-gradient(180deg, #FAFAFA 0%, #FFC7D3 100%)',
                    'default': '#FAFAFA'
                };

                if (currentPage == 'result-page') {
                    document.body.style.background = 'transparent';
                } else {
                    document.body.style.background = backgrounds[currentPage] || backgrounds['default'];
                }

                document.querySelector('.main').style.background = backgrounds[currentPage] || backgrounds['default'];
            };

            const initDesignSwiper = () => {
                const designSwiper = new Swiper('.design-slider__swiper', {
                    direction: 'horizontal',
                    slidesPerView: 1,
                    spaceBetween: 13,
                    pagination: {
                        el: '.design-slider__swiper-pagination',
                    },
                    on: {
                        slideChangeTransitionEnd: selectDesign
                    }
                });
                selectDesign();
            };

            const selectDesign = () => {
                const activeSlide = document.querySelector('.swiper-slide-active .design-card');
                const designInput = document.querySelector('.design-page__my-input');

                activeDesign = activeSlide.getAttribute('data-design');
                activeDesignImg = activeSlide.querySelector('.design-card__img').getAttribute('src');

                designInput.value = activeDesign;

                console.log(designInput.value, activeDesignImg);
            };

            const initTextSwiper = () => {
                const textSwiper = new Swiper('.text-slider__swiper', {
                    direction: 'horizontal',
                    slidesPerView: 1,
                    spaceBetween: 13,
                    on: {
                        slideChangeTransitionEnd: selectText
                    }
                });
                selectText();
            };

            const selectText = () => {
                const activeSlide = document.querySelector('.swiper-slide-active .text-card__text');
                const designCardTitle = document.querySelector('.text-page__design-card .design-card__title');
                const cardTextInput = document.querySelector('.text-page__my-input');

                let slideText = activeSlide.innerHTML.replace(/<br\s*\/?>/gi, '');
                slideText = slideText.replace(/\s{2,}/g, ' ').trim();

                cardTextInput.value = slideText;
                designCardTitle.innerHTML = cardTextInput.value;
                selectedText = cardTextInput.value;

                console.log(cardTextInput.value, activeDesign, selectedText);
            };

            const saveInputText = () => {
                const nameInput = document.querySelector('.name-page__my-input');
                if (nameInput.value) {
                    let nameValue = nameInput.value.replace(/\s/g, '').trim();
                    resultText = `${nameValue}, ${selectedText}`;

                    console.log(activeDesign, resultText);
                }
            };

            const postData = () => {
                const data = {
                    text: resultText,
                    design: +activeDesign
                };
                console.log('Данные, отправляемые на сервер:', data);

                fetch('https://nikolajgromkov.ru/flex/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data),
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Ошибка сети или сервера');
                        }
                        return response.json();
                    })
                    .then(result => {
                        console.log('Данные успешно отправлены и получен ответ:', result);

                        setPageDisplay(loadingPage, 'none');
                        setPageDisplay(resultPage, 'block');
                        setBackground('result-page');

                        imgUrl = result.url;

                        const imgElement = document.querySelector('.result-page__design-card-img');
                        const downloadLink = document.querySelector('.result-page__link');

                        imgElement.src = imgUrl;
                        downloadLink.href = imgUrl;

                        window.addEventListener('beforeunload', () => {
                            localStorage.clear();
                            localStorage.setItem('imgUrl', imgUrl);
                        });
                    })
                    .catch(error => {
                        console.error('Ошибка при отправке запроса:', error);
                    });
            };

            const setupTextPage = () => {
                const designCard = document.querySelector('.text-page__design-card.design-card');
                const designCardImg2 = designCard.querySelector('.design-card__img');
                designCard.setAttribute('data-design', activeDesign);
                designCardImg2.setAttribute('src', activeDesignImg);

                const textSliderWrapper = document.querySelector('.text-slider__swiper-wrapper');
                const textSlide = document.querySelector('.text-slider__slide');
                const textCardText = document.querySelector('.text-card .text-card__text');

                const arrTexts = [
                    ['ты же обещала, что будем ходить во Флекс вместе'],
                    ['начни уже эти чертовы тренировки'],
                    ['у тебя всё получится'],
                    ['я хочу сходить с тобой на Power Strike'],
                    ['давай помедитируем на йоге вместе? '],
                    ['давай полетаем на SkyFlex?'],
                    ['когда, если не сейчас?'],
                    ['ты такая классная'],
                ];

                textCardText.innerHTML = arrTexts[0][0];
                arrTexts.shift();

                for (let texts of arrTexts) {
                    const newSlide = textSlide.cloneNode(true);
                    const newTextCardText = newSlide.querySelector('.text-card__text');

                    for (let text of texts) {
                        newTextCardText.innerHTML = text;
                    }

                    textSliderWrapper.append(newSlide);
                }

                selectText();
            };

            const setupResultPage = () => {
                const imgElement = document.querySelector('.result-page__design-card-img');
                const downloadLink = document.querySelector('.result-page__button');

                imgElement.src = imgUrl;
                downloadLink.href = imgUrl;

                window.addEventListener('beforeunload', () => {
                    localStorage.clear();
                    localStorage.setItem('imgUrl', imgUrl);
                });
            };

            const currentPage = localStorage.getItem('currentPage') || 'main-page';
            localStorage.setItem('currentPage', currentPage);
            setBackground(currentPage);

            switch (currentPage) {
                case 'main-page':
                    setPageDisplay(mainPage, 'block');
                    break;
                case 'design-page':
                    setPageDisplay(designPage, 'block');
                    initDesignSwiper();
                    break;
                case 'text-page':
                    setPageDisplay(textPage, 'block');
                    initTextSwiper();
                    setupTextPage();
                    break;
                case 'name-page':
                    setPageDisplay(namePage, 'block');
                    document.querySelector('.name-page__button').addEventListener('click', saveInputText);
                    break;
                case 'loading-page':
                    setPageDisplay(loadingPage, 'block');
                    setTimeout(postData, 1000);
                    break;
                case 'result-page':
                    setPageDisplay(resultPage, 'block');
                    setupResultPage();
                    break;
            }

            document.querySelector('.main__button').addEventListener('click', () => {
                setPageDisplay(mainPage, 'none');
                setPageDisplay(designPage, 'block');
                localStorage.setItem('currentPage', 'design-page');
                setBackground(localStorage.getItem('currentPage'));
                initDesignSwiper();
            });

            document.querySelector('.logo-link').addEventListener('click', () => {
                setPageDisplay(mainPage, 'block');
                setPageDisplay(designPage, 'none');
                setPageDisplay(textPage, 'none');
                setPageDisplay(namePage, 'none');
                setPageDisplay(loadingPage, 'none');
                setPageDisplay(resultPage, 'none');
                localStorage.setItem('currentPage', 'main-page');
                setBackground(localStorage.getItem('currentPage'));
            });

            document.querySelector('.name-page__button').addEventListener('click', () => {
                setPageDisplay(mainPage, 'none');
                setPageDisplay(designPage, 'none');
                setPageDisplay(textPage, 'none');
                setPageDisplay(namePage, 'none');
                setPageDisplay(loadingPage, 'block');
                localStorage.setItem('currentPage', 'loading-page');
                setBackground(localStorage.getItem('currentPage'));
                setTimeout(postData, 1000);
            });

            document.querySelector('.text-page__button').addEventListener('click', () => {
                setPageDisplay(mainPage, 'none');
                setPageDisplay(designPage, 'none');
                setPageDisplay(textPage, 'none');
                setPageDisplay(namePage, 'block');
                localStorage.setItem('currentPage', 'name-page');
                setBackground(localStorage.getItem('currentPage'));
                document.querySelector('.name-page__button').addEventListener('click', saveInputText);
            });

            document.querySelector('.design-page__button').addEventListener('click', () => {
                setPageDisplay(designPage, 'none');
                setPageDisplay(textPage, 'block');
                localStorage.setItem('currentPage', 'text-page');
                setBackground(localStorage.getItem('currentPage'));
                initTextSwiper();
                setupTextPage();
            });

            // очистка localStorage при закрытии страницы
            window.addEventListener('beforeunload', () => {
                localStorage.clear();
            });

            // таймер для очистки localStorage и перехода на первую страницу после минуты бездействия
            let inactivityTimer = null;

            const resetInactivityTimer = () => {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    localStorage.clear();
                    setPageDisplay(mainPage, 'block');
                    setPageDisplay(designPage, 'none');
                    setPageDisplay(textPage, 'none');
                    setPageDisplay(namePage, 'none');
                    setPageDisplay(loadingPage, 'none');
                    setPageDisplay(resultPage, 'none');
                    localStorage.setItem('currentPage', 'main-page');
                    setBackground(localStorage.getItem('currentPage'));
                }, 60000); // 60000 миллисекунд = 1 минута
            };

            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);

            resetInactivityTimer();
        });
    </script>
</body>

</html>