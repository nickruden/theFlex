<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheFlex</title>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/header.css">
    <link rel="stylesheet" href="./css/UI/button.css">
    <link rel="stylesheet" href="./css/UI/input.css">
    <link rel="stylesheet" href="./css/card.css">

    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/pages/design.css">
    <link rel="stylesheet" href="./css/pages/text.css">
    <link rel="stylesheet" href="./css/pages/name.css">
    <link rel="stylesheet" href="./css/pages/loading.css">
    <link rel="stylesheet" href="./css/pages/result.css">
</head>

<body>
    <div class="wrapper">
        <header class="header">
            <a href="./index.html" class="logo-link">
                <div class="logo-wrap">
                    <img src="./imgs/Logo.svg" alt="" class="logo">
                </div>
            </a>
        </header>
        <main class="main">
            <div class="main-page" style="display: none;">
                <div class="main__container my-container">
                    <div class="main-page__text text">
                        <h1 class="main__title">Hey, flexgirl</h1>
                        <p class="main__pre-title">Ты можешь создать классное <span>персональное приглашение</span> на
                            пробную
                            тренировку <br> для своей <span>подруги</span></p>
                    </div>
                    <button class="main__button my-button">
                        <div class="my-button__icon-wrap">
                            <img src="./imgs/button/lightning.svg" alt="" class="my-button__icon">
                        </div>
                        <span class="my-button__text">нажми, если готова начать</span>
                    </button>
                    <div class="main__reposts reposts">
                        <div class="reposts__counter">
                            <div class="reposts__imgs">
                                <div class="reposts__img-wrap">
                                    <img src="./imgs/reports.png" alt="" class="reposts__img">
                                </div>
                                <div class="reposts__img-wrap">
                                    <img src="./imgs/reports.png" alt="" class="reposts__img">
                                </div>
                                <div class="reposts__img-wrap">
                                    <img src="./imgs/reports.png" alt="" class="reposts__img">
                                </div>
                                <div class="reposts__img-wrap">
                                    <img src="./imgs/reports.png" alt="" class="reposts__img">
                                </div>
                            </div>
                            <div class="reposts__count-text">+<span class="reposts__count">356</span></div>
                        </div>
                        <div class="reposts__text">flex girl отправили приглашение своим подругам</div>
                    </div>
                </div>
                <div class="main__background-images">
                    <img src="./imgs/gray-bag.png" alt="" class="main__gray-back-img">
                    <img src="./imgs/card-img.png" alt="" class="main__card-img">
                </div>
                <img src="./imgs/pink-bottle.png" alt="" class="main__pink-bottle-img">
            </div>
            <div class="main__design design-page" style="display: none;">
                <div class="design-page__container my-container">
                    <div class="design-page__content content">
                        <div class="design-page__text text">
                            <h2 class="design-page__title inner-title">Выбери оформление</h2>
                        </div>
                        <div class="design-page__constructor constructor">
                            <input class="my-input design-page__my-input" type="text" name="design">
                            <div class="design-page__slider design-slider">
                                <div class="swiper design-slider__swiper">
                                    <div class="swiper-wrapper design-slider__swiper-wrapper">
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__card design-card" data-design="1">
    
                                            </div>
                                        </div>
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__card design-card" data-design="2">
    
                                            </div>
                                        </div>
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__card design-card" data-design="3">
    
                                            </div>
                                        </div>
                                        <div class="swiper-slide design-slider__slide">
                                            <div class="design-slider__card design-card" data-design="4">
    
                                            </div>
                                        </div>
                                    </div>
                                    <div class="swiper-pagination design-slider__swiper-pagination"></div>
                                </div>
                            </div>
                        </div>
                        <button class="design-page__button my-button">
                            <div class="my-button__icon-wrap">
                                <img src="../imgs/button/arrow.svg" alt="" class="my-button__icon">
                            </div>
                            <span class="my-button__text">следующий шаг</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="main__text text-page" style="display: none;">
                <div class="text-page__container my-container">
                    <div class="text-page__content content">
                        <div class="text-page__text text">
                            <h2 class="text-page__title inner-title">Выбери текст</h2>
                        </div>
                        <div class="text-page__constructor constructor">
                            <input class="my-input text-page__my-input" type="text" name="cardText">
                            <div class="text-page__slider text-slider">
                                <div class="swiper text-slider__swiper">
                                    <div class="swiper-wrapper text-slider__swiper-wrapper">
                                        <div class="swiper-slide text-slider__slide swiper-slide-active">
                                            <div class="text-slider__card text-card">
                                                <div class="text-card__inner">
                                                    <div class="text-card__text">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-page__design-card-container">
                                <div class="text-page__design-card design-card">
                                    <div class="design-card__body">
                                        <div class="design-card__header">
                                            <div class="design-card__top-text">e-сертификат</div>
                                            <img src="../imgs/Logo.svg" alt="" class="design-card__logo-img">
                                        </div>
                                        <div class="design-card__title"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="my-button text-page__button">
                            <div class="my-button__icon-wrap">
                                <img src="../imgs/button/arrow.svg" alt="" class="my-button__icon">
                            </div>
                            <span class="my-button__text">следующий шаг</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="main__name name-page" style="display: none;">
                <div class="name-page__container my-container">
                    <div class="name-page__content content">
                        <div class="name-page__text text">
                            <h2 class="name-page__title inner-title">Введи имя подруги</h2>
                        </div>
                        <div class="name-page__constructor constructor">
                            <input class="my-input name-page__my-input" type="text" name="name" placeholder="Введите имя">
                        </div>
                        <button class="name-page__button my-button">
                            <div class="my-button__icon-wrap">
                                <img src="../imgs/button/arrow.svg" alt="" class="my-button__icon">
                            </div>
                            <span class="my-button__text">следующий шаг</span>
                            </butt>
                    </div>
                </div>
            </div>
            <div class="main__loading loading-page" style="display: none;">
                <div class="loading-page__container my-container">
                    <div class="loading-page__loader loader-wrap">
                        <div class="loader-wrap__text">Происходит магия</div>
                        <div class="loader-wrap__loader"></div>
                    </div>
                </div>
            </div>
            <div class="main__result result-page" style="display: none;">
                <div class="result-page__container my-container">
                    <div class="result-page__content content">
                        <div class="result-page__text text">
                            <h2 class="result-page__title inner-title">Готово</h2>
                        </div>
                        <div class="result-page__constructor constructor">
                            <div class="result-page__design-card design-card">
                                <img src="" alt="" class="result-page__design-card-img">
                            </div>
                        </div>
                        <a href="" class="result-page__button my-button" download>
                            <div class="my-button__icon-wrap">
                                <img src="../imgs/button/arrow.svg" alt="" class="my-button__icon">
                            </div>
                            <span class="my-button__text">Скачать</span>
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <script>
        document.querySelector('.main-page').style.display = 'block';
        const mainPage = document.querySelector('.main-page');
        const designPage = document.querySelector('.design-page');
        const textPage = document.querySelector('.text-page');
        const namePage = document.querySelector('.name-page');
        const resultPage = document.querySelector('.result-page');
        const loadingPage = document.querySelector('.loading-page');

        if (mainPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#FCFCFC';
        } else if (loadingPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#E5FB22';
        } else {
            document.body.style.backgroundColor = '#FAFAFA';
        };

        let currentPage = localStorage.getItem('currentPage');
        if (currentPage === 'design-page') {
            document.querySelector('.main-page').style.display = 'none';
            document.querySelector('.design-page').style.display = 'block';
            initDesignSwiper();
            if (mainPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#FCFCFC';
        } else if (loadingPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#E5FB22';
        } else {
            document.body.style.backgroundColor = '#FAFAFA';
        };
        } else if (currentPage === 'name-page') {
            document.querySelector('.main-page').style.display = 'none';
            document.querySelector('.design-page').style.display = 'none';
            document.querySelector('.text-page').style.display = 'none';
            document.querySelector('.name-page').style.display = 'block';
            if (mainPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#FCFCFC';
        } else if (loadingPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#E5FB22';
        } else {
            document.body.style.backgroundColor = '#FAFAFA';
        };
            document.addEventListener('DOMContentLoaded', function () {
                const nameInput = document.querySelector('.name-page__my-input');
                const saveButton = document.querySelector('.name-page__button');

                function saveLocalStorage() {
                    if (nameInput.value) {
                        let nameValue = nameInput.value.replace(/\s/g, '').trim();
                        const selectedText = localStorage.getItem('selectedText');
                        const resultText = `${nameValue}, ${selectedText}`;

                        localStorage.setItem('resultText', resultText);
                        console.log(localStorage.getItem('activeDesign'), localStorage.getItem('resultText'))
                    }
                }

                saveButton.addEventListener('click', saveLocalStorage);
            });
        } else if (currentPage === 'text-page') {
            document.querySelector('.main-page').style.display = 'none';
            document.querySelector('.design-page').style.display = 'none';
            document.querySelector('.text-page').style.display = 'block';
            if (mainPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#FCFCFC';
        } else if (loadingPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#E5FB22';
        } else {
            document.body.style.backgroundColor = '#FAFAFA';
        };
            const textSwiper = new Swiper('.text-slider__swiper', {
                direction: 'horizontal',
                slidesPerView: 1,
                spaceBetween: 13,
                on: {
                    slideChangeTransitionEnd: function () {
                        updateText();
                    }
                }
            });

            function updateText() {
                const activeSlide = document.querySelector('.swiper-slide-active .text-card__text');
                const designCardTitle = document.querySelector('.text-page__design-card .design-card__title');
                const cardTextInput = document.querySelector('.text-page__my-input');

                let slideText = activeSlide.innerHTML.replace(/<br\s*\/?>/gi, '');
                slideText = slideText.replace(/\s{2,}/g, ' ').trim();

                cardTextInput.value = slideText;
                designCardTitle.innerHTML = cardTextInput.value;
                localStorage.setItem('selectedText', cardTextInput.value);

                console.log(cardTextInput.value, localStorage.getItem('activeDesign'), localStorage.getItem('selectedText'))
            }

            const designCard = document.querySelector('.text-page__design-card.design-card');
            const design = localStorage.getItem('activeDesign');
            designCard.setAttribute('data-design', design);

            const textSliderWrapper = document.querySelector('.text-slider__swiper-wrapper');
            const textSlide = document.querySelector('.text-slider__slide');
            const textCardText = document.querySelector('.text-card .text-card__text');
            console.log(textSlide)

            const arrTexts = [
                ['ты же обещала, что будем ходить во Флекс вместе'],
                ['начни уже эти чертовы тренировки'],
                ['у тебя всё получится'],
                ['я хочу сходить с тобой на Power Strike'],
                ['давай помедитируем на йоге вместе? '],
                ['давай полетаем на SkyFlex?'],
                ['когда, если не сейчас?'],
                ['ты такая классная'],
            ];

            textCardText.innerHTML = arrTexts[0][0];
            arrTexts.shift();

            for (let texts of arrTexts) {
                const newSlide = textSlide.cloneNode(true);
                const newTextCardText = newSlide.querySelector('.text-card__text');

                for (let text of texts) {
                    newTextCardText.innerHTML = text;
                }

                textSliderWrapper.append(newSlide);
            }

            console.log('Active slide:', document.querySelector('.swiper-slide-active'));
            updateText();
        } else if (currentPage === 'result-page') {
            document.querySelector('.main-page').style.display = 'none';
            document.querySelector('.design-page').style.display = 'none';
            document.querySelector('.text-page').style.display = 'none';
            document.querySelector('.name-page').style.display = 'none';
            document.querySelector('.result-page').style.display = 'block';
            if (mainPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#FCFCFC';
        } else if (loadingPage.style.display !== 'none') {
            document.body.style.backgroundColor = '#E5FB22';
        } else {
            document.body.style.backgroundColor = '#FAFAFA';
        };
            document.addEventListener('DOMContentLoaded', function () {
                const imgElement = document.querySelector('.result-page__design-card-img');
                const downloadLink = document.querySelector('.result-page__button');
                const imgUrl = localStorage.getItem('imgUrl');

                imgElement.src = imgUrl;
                downloadLink.href = imgUrl;

                window.addEventListener('beforeunload', function () {
                    const imgUrl = localStorage.getItem('imgUrl');

                    localStorage.clear();

                    localStorage.setItem('imgUrl', imgUrl);
                });
            });
        }

        function initDesignSwiper() {
            const designSwiper = new Swiper('.design-slider__swiper', {
                direction: 'horizontal',
                slidesPerView: 1,
                spaceBetween: 13,
                pagination: {
                    el: '.design-slider__swiper-pagination',
                },
                on: {
                    slideChangeTransitionEnd: function () {
                        updateDesign();
                    }
                }
            });
            updateDesign()
        }

        function updateDesign() {
            const activeSlide = document.querySelector('.swiper-slide-active .design-card');
            const designInput = document.querySelector('.design-page__my-input');

            const designValue = activeSlide.getAttribute('data-design');

            designInput.value = designValue;
            localStorage.setItem('activeDesign', designValue);

            console.log(designInput.value, localStorage.getItem('activeDesign'));
        }

        document.querySelector('.main__button').addEventListener('click', function () {
            document.querySelector('.main-page').style.display = 'none';
            document.querySelector('.design-page').style.display = 'block';
            localStorage.setItem('currentPage', 'design-page');
            initDesignSwiper();
        });

        document.querySelector('.logo-link').addEventListener('click', function () {
            document.querySelector('.main-page').style.display = 'block';
            document.querySelector('.design-page').style.display = 'none';
            document.querySelector('.text-page').style.display = 'none';
            document.querySelector('.name-page').style.display = 'none';
            document.querySelector('.loading-page').style.display = 'none';
            document.querySelector('.result-page').style.display = 'none';
            localStorage.setItem('currentPage', 'main-page');
        });

        document.querySelector('.name-page__button').addEventListener('click', function () {
            document.querySelector('.main-page').style.display = 'none';
            document.querySelector('.design-page').style.display = 'none';
            document.querySelector('.text-page').style.display = 'none';
            document.querySelector('.name-page').style.display = 'none';
            document.querySelector('.loading-page').style.display = 'block';

                function sendData() {
                    const design = localStorage.getItem('activeDesign');
                    const text = localStorage.getItem('resultText');

                    const data = {
                        text: text,
                        design: +design
                    };
                    console.log(data)

                    fetch('https://nikolajgromkov.ru/flex/', {
                        method: 'POST',
                        body: JSON.stringify(data),
                    })
                        .then(response => response.json())
                        .then(result => {
                            localStorage.setItem('imgUrl', result.url);
                            document.querySelector('.loading-page').style.display = 'none';
                            document.querySelector('.result-page').style.display = 'block';
                            localStorage.setItem('currentPage', 'result-page');
                            document.addEventListener('DOMContentLoaded', function () {
                const imgElement = document.querySelector('.result-page__design-card-img');
                const downloadLink = document.querySelector('.result-page__button');
                const imgUrl = localStorage.getItem('imgUrl');

                imgElement.src = imgUrl;
                downloadLink.href = imgUrl;

                window.addEventListener('beforeunload', function () {
                    const imgUrl = localStorage.getItem('imgUrl');

                    localStorage.clear();

                    localStorage.setItem('imgUrl', imgUrl);
                });
            });
                        })
                        .catch(error => {
                            console.error('Ошибка при отправке запроса:', error);
                        });
                }

                setTimeout(sendData, 1000);
        });

        document.querySelector('.text-page__button').addEventListener('click', function () {
            document.querySelector('.main-page').style.display = 'none';
            document.querySelector('.design-page').style.display = 'none';
            document.querySelector('.text-page').style.display = 'none';
            document.querySelector('.name-page').style.display = 'block';
            localStorage.setItem('currentPage', 'name-page');
            document.addEventListener('DOMContentLoaded', function () {
                const nameInput = document.querySelector('.name-page__my-input');
                const saveButton = document.querySelector('.name-page__button');

                function saveLocalStorage() {
                    if (nameInput.value) {
                        let nameValue = nameInput.value.replace(/\s/g, '').trim();
                        const selectedText = localStorage.getItem('selectedText');
                        const resultText = `${nameValue}, ${selectedText}`;

                        localStorage.setItem('resultText', resultText);
                        console.log(localStorage.getItem('activeDesign'), localStorage.getItem('resultText'))
                    }
                }

                saveButton.addEventListener('click', saveLocalStorage);
            });
        });



        // function initTextSwiper() {
        //     const textSwiper = new Swiper('.text-slider__swiper', {
        //         direction: 'horizontal',
        //         slidesPerView: 1,
        //         spaceBetween: 13,
        //         on: {
        //             slideChangeTransitionEnd: function () {
        //                 updateText();
        //             }
        //         }
        //     });
        //     updateText();
        // }

        // function updateText() {
        //     const activeSlide = document.querySelector('.swiper-slide-active .text-card__text');
        //     const designCardTitle = document.querySelector('.text-page__design-card .design-card__title');
        //     const cardTextInput = document.querySelector('.text-page__my-input');

        //     let slideText = activeSlide.innerHTML.replace(/<br\s*\/?>/gi, '');
        //     slideText = slideText.replace(/\s{2,}/g, ' ').trim();

        //     cardTextInput.value = slideText;
        //     designCardTitle.innerHTML = cardTextInput.value;
        //     localStorage.setItem('selectedText', cardTextInput.value);

        //     console.log(cardTextInput.value, localStorage.getItem('activeDesign'), localStorage.getItem('selectedText'))
        // }

        document.querySelector('.design-page__button').addEventListener('click', function () {
            document.querySelector('.design-page').style.display = 'none';
            document.querySelector('.text-page').style.display = 'block';
            localStorage.setItem('currentPage', 'text-page');

            const textSwiper = new Swiper('.text-slider__swiper', {
                direction: 'horizontal',
                slidesPerView: 1,
                spaceBetween: 13,
                on: {
                    slideChangeTransitionEnd: function () {
                        updateText();
                    }
                }
            });

            function updateText() {
                const activeSlide = document.querySelector('.swiper-slide-active .text-card__text');
                const designCardTitle = document.querySelector('.text-page__design-card .design-card__title');
                const cardTextInput = document.querySelector('.text-page__my-input');

                let slideText = activeSlide.innerHTML.replace(/<br\s*\/?>/gi, '');
                slideText = slideText.replace(/\s{2,}/g, ' ').trim();

                cardTextInput.value = slideText;
                designCardTitle.innerHTML = cardTextInput.value;
                localStorage.setItem('selectedText', cardTextInput.value);

                console.log(cardTextInput.value, localStorage.getItem('activeDesign'), localStorage.getItem('selectedText'))
            }

            const designCard = document.querySelector('.text-page__design-card.design-card');
            const design = localStorage.getItem('activeDesign');
            designCard.setAttribute('data-design', design);

            const textSliderWrapper = document.querySelector('.text-slider__swiper-wrapper');
            const textSlide = document.querySelector('.text-slider__slide');
            const textCardText = document.querySelector('.text-card .text-card__text');
            console.log(textSlide)

            const arrTexts = [
                ['ты же обещала, что будем ходить во Флекс вместе'],
                ['начни уже эти чертовы тренировки'],
                ['у тебя всё получится'],
                ['я хочу сходить с тобой на Power Strike'],
                ['давай помедитируем на йоге вместе? '],
                ['давай полетаем на SkyFlex?'],
                ['когда, если не сейчас?'],
                ['ты такая классная'],
            ];

            textCardText.innerHTML = arrTexts[0][0];
            arrTexts.shift();

            for (let texts of arrTexts) {
                const newSlide = textSlide.cloneNode(true);
                const newTextCardText = newSlide.querySelector('.text-card__text');

                for (let text of texts) {
                    newTextCardText.innerHTML = text;
                }

                textSliderWrapper.append(newSlide);
            }

            console.log('Active slide:', document.querySelector('.swiper-slide-active'));
            updateText();
        });
    </script>
</body>

</html>